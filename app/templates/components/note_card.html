{% for note in notes %}
<div class="card p-5 {% if note.processing_status=="completed" %}cursor-pointer hover:shadow-lg hover:-translate-y-1{% endif %} transition-all duration-200" {% if
    note.processing_status=="completed" %} hx-get="/web/notes/{{ note.id }}" hx-push-url="true" hx-target="main" {% else
    %}{% endif %}>

    <!-- SSE Listener for Card Refresh (when processing complete) -->
    <div hx-get="/web/notes/{{ note.id }}/card" hx-trigger="sse:note-processed-{{ note.id }} from:body"
        hx-swap="outerHTML" hx-target="closest .card"></div>

    <!-- Status Badge and Actions (if not completed) -->
    {% if note.processing_status != "completed" %}
    <div class="mb-3" hx-get="/web/notes/{{ note.id }}/status" hx-trigger="sse:note-status-{{ note.id }} from:body"
        hx-swap="outerHTML">
        <div class="flex items-center justify-between gap-2">
            <span class="status-badge status-{{ note.processing_status }}">
                {% if note.processing_status in ["pending", "transcribing", "processing"] %}
                <svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                {{ note.processing_status }}
                {% elif note.processing_status == "failed" %}
                <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Failed
                {% endif %}
            </span>

            {% if note.processing_status == "failed" %}
            <div class="flex gap-1">
                <!-- Retry Button -->
                <button hx-post="/api/notes/{{ note.id }}/retry"
                    hx-swap="none"
                    class="btn-small btn-retry"
                    title="Retry processing">
                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>
                <!-- Delete Button -->
                <button hx-delete="/api/notes/{{ note.id }}"
                    hx-confirm="Delete this failed note? This action cannot be undone."
                    hx-target="closest .card"
                    class="btn-small btn-delete"
                    title="Delete note">
                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>
            </div>
            {% endif %}
        </div>

        {% if note.processing_status == "failed" and note.error_message %}
        <div class="text-xs mt-2" style="color: var(--color-error);">
            {{ note.error_message[:50] }}{% if note.error_message|length > 50 %}...{% endif %}
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Summary or Transcript Preview -->
    <h3 class="font-semibold text-lg mb-2 line-clamp-2">
        {% if note.summary %}
        {{ note.summary }}
        {% elif note.raw_transcript %}
        {{ note.raw_transcript[:60] }}{% if note.raw_transcript|length > 60 %}...{% endif %}
        {% else %}
        <span style="color: var(--color-text-tertiary);">Processing...</span>
        {% endif %}
    </h3>

    <!-- Transcript Preview (if summary exists) -->
    {% if note.summary and note.raw_transcript %}
    <p class="text-sm mb-3 line-clamp-2" style="color: var(--color-text-secondary);">
        {{ note.raw_transcript[:100] }}{% if note.raw_transcript|length > 100 %}...{% endif %}
    </p>
    {% endif %}

    <!-- Footer: Tag, Reminder & Timestamp -->
    <div class="flex items-center justify-between mt-4">
        <div class="flex items-center gap-2">
            {% if note.notification_timestamp %}
            <span class="reminder-badge" title="{{ note.notification_timestamp.strftime('%Y-%m-%d %H:%M') }}">
                <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="reminder-text" data-reminder="{{ note.notification_timestamp.isoformat() }}">
                    {% if note.processing_status == "completed" %}
                    <!-- Will be set by JavaScript -->
                    {% else %}
                    Scheduled
                    {% endif %}
                </span>
            </span>
            {% endif %}

            {% if note.tag %}
            <span class="tag-badge">
                {{ note.tag }}
            </span>
            {% endif %}
        </div>

        <span class="text-xs" style="color: var(--color-text-tertiary);">
            {{ note.created_at.strftime('%b %d, %Y') }}
        </span>
    </div>
</div>
{% else %}
<!-- Empty State -->
<div class="col-span-full text-center py-16">
    <svg class="w-16 h-16 mx-auto mb-4" style="color: var(--color-text-tertiary);" fill="none" viewBox="0 0 24 24"
        stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
            d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
    </svg>
    <h3 class="text-xl font-semibold mb-2">No notes yet</h3>
    <p style="color: var(--color-text-secondary);">Upload a voice note to get started</p>
</div>
{% endfor %}

{% if show_count and notes %}
<script>
    document.getElementById('notes-count').textContent = '{{ total }} note{% if total != 1 %}s{% endif %}';
</script>
{% endif %}
