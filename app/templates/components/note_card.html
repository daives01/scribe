{% for note in notes %}
<div class="note-card group bg-white dark:bg-neutral-950 border border-slate-200 dark:border-slate-800 rounded-xl shadow-sm hover:shadow-md hover:border-slate-300 dark:hover:border-slate-700 transition-all duration-200 p-5 relative overflow-hidden {% if note.processing_status=="completed" %}cursor-pointer{% endif %}" {% if
   note.processing_status=="completed" %} hx-get="/web/notes/{{ note.id }}" hx-push-url="true" hx-target="main" {% else
   %}{% endif %}>

    <!-- Archive Button (Top Right) -->
    {% if note.processing_status == "completed" %}
    <button hx-patch="/web/notes/{{ note.id }}/archive"
        hx-target="closest .note-card"
        hx-swap="outerHTML"
        hx-on:click="event.stopPropagation()"
        class="absolute top-3 right-3 w-7 h-7 flex items-center justify-center rounded-lg text-sm transition-all duration-200 z-10 opacity-0 group-hover:opacity-100 hover:bg-slate-100 dark:hover:bg-slate-800 text-neutral-400 hover:text-neutral-600 dark:hover:text-neutral-300"
        title="Archive note">
        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-4 4H9" />
        </svg>
    </button>
    {% endif %}

    <!-- SSE Listener for Card Refresh (when processing complete) -->
    <div hx-get="/web/notes/{{ note.id }}/card" hx-trigger="sse:note-processed-{{ note.id }} from:body"
        hx-swap="outerHTML" hx-target="closest .note-card"></div>

    <!-- Status Badge and Actions -->
    <div class="mb-3" hx-get="/web/notes/{{ note.id }}/status" hx-trigger="sse:note-status-{{ note.id }} from:body"
        hx-swap="outerHTML">
        <div class="flex items-center justify-between gap-2">
               {% if note.processing_status != "completed" %}
               {% from "components/status_badge.html" import status_badge %}
               {{ status_badge(note.processing_status) }}
               {% endif %}

              <div class="flex gap-1">
                  {% if note.processing_status == "failed" %}
                  <button hx-post="/api/notes/{{ note.id }}/retry"
                      hx-swap="none"
                      class="w-7 h-7 flex items-center justify-center rounded-lg text-sm transition-colors bg-blue-50 dark:bg-blue-950/30 text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-950/50"
                      title="Retry processing">
                      <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                      </svg>
                  </button>
                  {% endif %}
              </div>
          </div>

          {% if note.processing_status == "failed" and note.error_message %}
          <div class="text-xs mt-1.5 text-red-600 dark:text-red-400">
              {{ note.error_message[:50] }}{% if note.error_message|length > 50 %}...{% endif %}
          </div>
          {% endif %}
      </div>

   <!-- Content Area - Progressive Loading -->
   {% if note.processing_status == "completed" %}
       <h3 class="mb-1.5 text-base font-semibold leading-snug line-clamp-2 text-neutral-900 dark:text-neutral-100">
           {% if note.summary %}
           {{ note.summary }}
           {% elif note.raw_transcript %}
           {{ note.raw_transcript[:80] }}{% if note.raw_transcript|length > 80 %}...{% endif %}
           {% endif %}
       </h3>

       {% if note.summary and note.raw_transcript %}
       <p class="mb-3 text-sm text-neutral-500 dark:text-neutral-400 line-clamp-2 leading-relaxed">
           {{ note.raw_transcript[:120] }}{% if note.raw_transcript|length > 120 %}...{% endif %}
       </p>
       {% endif %}
   {% else %}
       <h3 class="mb-1.5 text-base font-semibold leading-snug text-neutral-900 dark:text-neutral-100">
           {% if note.summary %}
           {{ note.summary }}
           {% elif note.raw_transcript %}
           {{ note.raw_transcript[:80] }}{% if note.raw_transcript|length > 80 %}...{% endif %}
           {% else %}
               {% from "components/shimmer.html" import shimmer %}
               {{ shimmer(height="h-5", width="w-[90%]") }}
           {% endif %}
       </h3>

       {% if not note.summary %}
           <p class="mb-3 text-sm text-neutral-500 dark:text-neutral-400">
               {% if note.raw_transcript %}
                   {{ note.raw_transcript[:120] }}{% if note.raw_transcript|length > 120 %}...{% endif %}
               {% else %}
                   {% from "components/shimmer.html" import shimmer %}
                   {{ shimmer(height="h-4", width="w-[100%]") }}
                   {{ shimmer(height="h-4", width="w-[70%]", extra_classes="mt-1") }}
               {% endif %}
           </p>
       {% endif %}
   {% endif %}

   <!-- Footer: Tags, Reminder & Timestamp -->
   <div class="flex items-center justify-between mt-auto">
       <div class="flex items-center gap-1.5 flex-wrap">
                {% if note.processing_status == "completed" %}
                 {% if note.notification_timestamp %}
                 {% from "components/reminder_badge.html" import reminder_badge %}
                 {{ reminder_badge(note.notification_timestamp) }}
                  {% endif %}

                 {% if note.tag %}
                 {% from "components/tag_badge.html" import tag_badge %}
                 {{ tag_badge(note.tag) }}
                 {% endif %}
            {% else %}
                {% if note.notification_timestamp %}
                 {% from "components/reminder_badge.html" import reminder_badge %}
                 {{ reminder_badge(note.notification_timestamp) }}
                 {% endif %}
                 {% if note.tag %}
                 {% from "components/tag_badge.html" import tag_badge %}
                 {{ tag_badge(note.tag) }}
                 {% endif %}
                 {% if not note.notification_timestamp and not note.tag %}
                 {% from "components/shimmer.html" import shimmer %}
                 {{ shimmer(width="w-[60px]", height="h-5", rounded="rounded-full") }}
                {% endif %}
            {% endif %}
       </div>

       <span class="text-xs text-neutral-400 dark:text-neutral-500">
           {{ note.created_at.strftime('%b %d') }}
       </span>
   </div>
</div>
{% endfor %}

{% if not notes %}
<!-- Empty State -->
<div class="col-span-full text-center py-16">
    <svg class="w-16 h-16 mx-auto mb-4 text-neutral-400 dark:text-neutral-600" fill="none" viewBox="0 0 24 24"
        stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
            d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
    </svg>
    <h3 class="text-xl font-semibold mb-2">No notes yet</h3>
    <p class="text-neutral-500 dark:text-neutral-400">Upload a voice note to get started</p>
</div>
{% endif %}

{% if show_count and notes %}
<script>
    document.getElementById('notes-count').textContent = '{{ total }} note{% if total != 1 %}s{% endif %}';
</script>
{% endif %}
