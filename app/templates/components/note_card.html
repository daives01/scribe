{% for note in notes %}
  <div id="note-card-{{ note.id }}" class="note-card group bg-white dark:bg-neutral-950 border border-slate-200 dark:border-slate-800 rounded-xl shadow-sm hover:shadow-md hover:border-slate-300 dark:hover:border-slate-700 transition-all duration-200 p-5 relative overflow-hidden {% if note.processing_status=="completed" %}cursor-pointer{% endif %}" {% if
     note.processing_status=="completed" %} hx-get="/web/notes/{{ note.id }}/modal" hx-target="#modal-container" hx-swap="innerHTML" hx-on:before-request="document.getElementById('modal-container').innerHTML = ''" {% else
     %}{% endif %}">

    <!-- Action Buttons (Top Right) -->
    <div class="absolute top-3 right-3 z-10">
        {% if note.processing_status == "completed" %}
        <button hx-patch="/web/notes/{{ note.id }}/archive"
            hx-target="closest .note-card"
            hx-swap="outerHTML"
            hx-on:click="event.stopPropagation()"
            class="w-8 h-8 flex items-center justify-center rounded-lg transition-all duration-200 opacity-0 group-hover:opacity-100 hover:bg-slate-100 dark:hover:bg-slate-800 text-neutral-400 hover:text-neutral-600 dark:hover:text-neutral-300"
            title="Archive note">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-4 4H9" />
            </svg>
        </button>
        {% elif note.processing_status == "failed" %}
        <div class="flex gap-1.5">
            <button hx-post="/api/notes/{{ note.id }}/retry"
                hx-swap="none"
                hx-on:click="event.stopPropagation()"
                class="w-8 h-8 flex items-center justify-center rounded-lg transition-all duration-200 bg-blue-50 dark:bg-blue-950/30 text-blue-600 dark:text-blue-400 hover:bg-blue-100 dark:hover:bg-blue-950/50"
                title="Retry processing">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
            </button>
            <button hx-delete="/web/notes/{{ note.id }}"
                hx-confirm="Delete this failed note?"
                hx-swap="none"
                hx-on:click="event.stopPropagation()"
                class="w-8 h-8 flex items-center justify-center rounded-lg transition-all duration-200 bg-red-50 dark:bg-red-950/30 text-red-500 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-950/50"
                title="Delete note">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        {% endif %}
    </div>

    <!-- SSE Listener for Card Refresh (when processing complete) -->
    <div hx-get="/web/notes/{{ note.id }}/card" hx-trigger="sse:note-processed-{{ note.id }} from:body"
        hx-swap="outerHTML" hx-target="closest .note-card"></div>

    <!-- Status Badge (for processing notes only) -->
    {% if note.processing_status in ["pending", "transcribing", "processing"] %}
    <div class="mb-3" hx-get="/web/notes/{{ note.id }}/status" hx-trigger="sse:note-status-{{ note.id }} from:body"
        hx-swap="outerHTML">
        {% from "components/status_badge.html" import status_badge %}
        {{ status_badge(note.processing_status) }}
    </div>
    {% endif %}

    <!-- Error Message (for failed notes only) -->
    {% if note.processing_status == "failed" %}
    <div class="mb-3 pr-20">
        <div class="flex items-center gap-2 mb-1.5">
            <span class="inline-flex items-center gap-1.5 rounded-full px-2.5 py-0.5 text-xs font-medium bg-red-100 text-red-700 dark:bg-red-950/30 dark:text-red-400">
                <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Failed
            </span>
        </div>
        {% if note.error_message %}
        <p class="text-xs text-red-600 dark:text-red-400 leading-relaxed">
            {{ note.error_message }}
        </p>
        {% endif %}
    </div>
    {% endif %}

    <!-- Content Area -->
    {% if note.processing_status == "completed" %}
        <h3 class="mb-1.5 text-base font-semibold leading-snug line-clamp-2 text-neutral-900 dark:text-neutral-100">
            {% if note.summary %}
            {{ note.summary }}
            {% elif note.raw_transcript %}
            {{ note.raw_transcript[:80] }}{% if note.raw_transcript|length > 80 %}...{% endif %}
            {% endif %}
        </h3>

        {% if note.summary and note.raw_transcript %}
        <p class="mb-3 text-sm text-neutral-500 dark:text-neutral-400 line-clamp-2 leading-relaxed">
            {{ note.raw_transcript[:120] }}{% if note.raw_transcript|length > 120 %}...{% endif %}
        </p>
        {% endif %}
    {% elif note.processing_status == "failed" %}
        <h3 class="mb-1.5 text-base font-semibold leading-snug text-neutral-900 dark:text-neutral-100">
            {% if note.summary %}
            {{ note.summary }}
            {% elif note.raw_transcript %}
            {{ note.raw_transcript[:80] }}{% if note.raw_transcript|length > 80 %}...{% endif %}
            {% else %}
                Failed to process
            {% endif %}
        </h3>

        {% if not note.summary %}
            <p class="mb-3 text-sm text-neutral-500 dark:text-neutral-400">
                {% if note.raw_transcript %}
                    {{ note.raw_transcript[:120] }}{% if note.raw_transcript|length > 120 %}...{% endif %}
                {% else %}
                    No transcript available
                {% endif %}
            </p>
        {% endif %}
    {% else %}
        <h3 class="mb-1.5 text-base font-semibold leading-snug text-neutral-900 dark:text-neutral-100">
            {% if note.summary %}
            {{ note.summary }}
            {% elif note.raw_transcript %}
            {{ note.raw_transcript[:80] }}{% if note.raw_transcript|length > 80 %}...{% endif %}
            {% else %}
                {% from "components/shimmer.html" import shimmer %}
                {{ shimmer(height="h-5", width="w-[90%]") }}
            {% endif %}
        </h3>

        {% if not note.summary %}
            <p class="mb-3 text-sm text-neutral-500 dark:text-neutral-400">
                {% if note.raw_transcript %}
                    {{ note.raw_transcript[:120] }}{% if note.raw_transcript|length > 120 %}...{% endif %}
                {% else %}
                    {% from "components/shimmer.html" import shimmer %}
                    {{ shimmer(height="h-4", width="w-[100%]") }}
                    {{ shimmer(height="h-4", width="w-[70%]", extra_classes="mt-1") }}
                {% endif %}
            </p>
        {% endif %}
    {% endif %}

    <!-- Footer: Tags, Reminder & Timestamp -->
    <div class="flex items-center justify-between mt-auto">
        <div class="flex items-center gap-1.5 flex-wrap">
            {% if note.processing_status == "completed" or note.processing_status == "failed" %}
                  {% if note.notification_timestamp %}
                  {% from "components/reminder_badge.html" import reminder_badge %}
                  {{ reminder_badge(note.notification_timestamp) }}
                   {% endif %}

                  {% if note.tag %}
                  {% from "components/tag_badge.html" import tag_badge %}
                  {{ tag_badge(note.tag) }}
                  {% endif %}
            {% else %}
                  {% if note.notification_timestamp %}
                  {% from "components/reminder_badge.html" import reminder_badge %}
                  {{ reminder_badge(note.notification_timestamp) }}
                  {% endif %}
                  {% if note.tag %}
                  {% from "components/tag_badge.html" import tag_badge %}
                  {{ tag_badge(note.tag) }}
                  {% endif %}
                  {% if not note.notification_timestamp and not note.tag %}
                  {% from "components/shimmer.html" import shimmer %}
                  {{ shimmer(width="w-[60px]", height="h-5", rounded="rounded-full") }}
                 {% endif %}
            {% endif %}
        </div>

        <span class="text-xs text-neutral-400 dark:text-neutral-500">
            {{ note.created_at.strftime('%b %d') }}
        </span>
    </div>
 </div>
{% endfor %}

{% if not notes %}
<!-- Empty State -->
<div class="col-span-full text-center py-16">
    <svg class="w-16 h-16 mx-auto mb-4 text-neutral-400 dark:text-neutral-600" fill="none" viewBox="0 0 24 24"
        stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
            d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
    </svg>
    <h3 class="text-xl font-semibold mb-2 text-neutral-900 dark:text-neutral-50">No notes yet</h3>
    <p class="text-neutral-500 dark:text-neutral-400">Upload a voice note to get started</p>
</div>
{% endif %}

{% if show_count and notes %}
<script>
    document.getElementById('notes-count').textContent = '{{ total }} note{% if total != 1 %}s{% endif %}';
</script>
{% endif %}
